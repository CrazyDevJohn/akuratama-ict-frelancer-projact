<!doctype html>
<html lang="si">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Upload Payment Slip | Your Site</title>
    <!-- Firebase SDKs -->
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="./database/api-calls.js"></script>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      /* Navigation Bar */
      .navbar {
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo i {
        color: #4dabf7;
      }

      .nav-buttons {
        display: flex;
        gap: 15px;
      }

      .nav-btn {
        background-color: rgba(255, 255, 255, 0.15);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
      }

      .nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.25);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* Main Container */
      .container {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
      }

      .page-header {
        text-align: center;
        margin-bottom: 40px;
      }

      .page-header h1 {
        color: #1e3c72;
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
      }

      .page-header p {
        color: #666;
        font-size: 1.1rem;
        max-width: 700px;
        margin: 0 auto;
      }

      /* Upload Card */
      .upload-card {
        background-color: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        margin-bottom: 30px;
        transition: transform 0.3s ease;
      }

      .upload-card:hover {
        transform: translateY(-5px);
      }

      .upload-area {
        border: 3px dashed #c0c0c0;
        border-radius: 15px;
        padding: 60px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 30px;
        background-color: #f8f9fa;
      }

      .upload-area:hover,
      .upload-area.dragover {
        border-color: #2a5298;
        background-color: #eef5ff;
      }

      .upload-icon {
        font-size: 70px;
        color: #2a5298;
        margin-bottom: 20px;
      }

      .upload-text h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.5rem;
      }

      .upload-text p {
        color: #777;
        margin-bottom: 20px;
      }

      .file-input {
        display: none;
      }

      .browse-btn {
        background-color: #2a5298;
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
      }

      .browse-btn:hover {
        background-color: #1e3c72;
        transform: scale(1.05);
      }

      /* Preview Section */
      .preview-section {
        display: none;
        margin-top: 30px;
        text-align: center;
      }

      .preview-section h3 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.3rem;
        text-align: left;
      }

      .preview-container {
        border-radius: 10px;
        overflow: hidden;
        max-width: 400px;
        margin: 0 auto 20px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      #imagePreview {
        width: 100%;
        display: block;
      }

      .file-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: left;
      }

      .file-info p {
        margin-bottom: 8px;
        display: flex;
        justify-content: space-between;
      }

      .file-info span {
        font-weight: 600;
        color: #2a5298;
      }

      /* Upload Button */
      .upload-btn {
        background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 18px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        margin-top: 10px;
        box-shadow: 0 4px 15px rgba(42, 82, 152, 0.3);
      }

      .upload-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(42, 82, 152, 0.4);
      }

      .upload-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Status Messages */
      .status-message {
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        text-align: center;
        font-weight: 600;
        display: none;
      }

      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .progress-container {
        margin-top: 20px;
        display: none;
      }

      .progress-bar {
        height: 10px;
        background-color: #e0e0e0;
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4dabf7, #2a5298);
        width: 0%;
        transition: width 0.3s ease;
      }

      .progress-text {
        text-align: center;
        color: #555;
        font-size: 14px;
      }

      /* Instructions */
      .instructions {
        background-color: #eef5ff;
        border-radius: 15px;
        padding: 25px;
        margin-top: 40px;
        border-left: 5px solid #2a5298;
      }

      .instructions h3 {
        color: #1e3c72;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .instructions ol {
        padding-left: 20px;
      }

      .instructions li {
        margin-bottom: 10px;
        color: #444;
      }

      /* Footer */
      .footer {
        text-align: center;
        padding: 20px;
        color: #666;
        margin-top: 40px;
        border-top: 1px solid #eee;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .navbar {
          padding: 15px;
          flex-direction: column;
          gap: 15px;
        }

        .nav-buttons {
          width: 100%;
          justify-content: center;
        }

        .container {
          margin: 20px auto;
        }

        .upload-card {
          padding: 25px;
        }

        .page-header h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="navbar">
      <div class="logo">
        <i class="fas fa-credit-card"></i>
        <span>Payment Portal</span>
      </div>
      <div class="nav-buttons">
        <a href="Dash.html" class="nav-btn">
          <i class="fas fa-arrow-left"></i>
          Back to Dashboard
        </a>
        <button class="nav-btn" onclick="location.href = 'index.html'">
          <i class="fas fa-home"></i>
          Home
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <div class="page-header">
        <h1><i class="fas fa-file-upload"></i> Upload Payment Slip</h1>
        <p>
          Upload a clear image of your bank payment slip for verification.
          Supported formats: JPG, PNG, PDF (Max: 5MB)
        </p>
      </div>

      <div class="upload-card">
        <div class="upload-area" id="uploadArea">
          <div class="upload-icon">
            <i class="fas fa-cloud-upload-alt"></i>
          </div>
          <div class="upload-text">
            <h3>Drag & Drop Your Payment Slip</h3>
            <p>or click to browse files</p>
            <button class="browse-btn" id="browseBtn">
              <i class="fas fa-folder-open"></i> Browse Files
            </button>
          </div>
          <input
            type="file"
            id="fileInput"
            class="file-input"
            accept="image/*,.pdf"
            enctype="multipart/form-data"
          />
        </div>

        <!-- Preview Section -->
        <div class="preview-section" id="previewSection">
          <h3><i class="fas fa-eye"></i> Preview</h3>
          <div class="preview-container">
            <img id="imagePreview" src="" alt="Payment Slip Preview" />
          </div>
          <div class="file-info" id="fileInfo">
            <!-- File info will be inserted here -->
          </div>

          <!-- Progress Bar -->
          <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">0% uploaded</div>
          </div>

          <button class="upload-btn" id="uploadBtn" disabled>
            <i class="fas fa-upload"></i> Upload to Firebase
          </button>
        </div>

        <!-- Status Messages -->
        <div class="status-message success" id="successMessage">
          <i class="fas fa-check-circle"></i> Payment slip uploaded
          successfully!
        </div>
        <div class="status-message error" id="errorMessage">
          <i class="fas fa-exclamation-circle"></i> An error occurred. Please
          try again.
        </div>
      </div>

      <!-- Instructions -->
      <div class="instructions">
        <h3><i class="fas fa-info-circle"></i> Important Instructions</h3>
        <ol>
          <li>Ensure the payment slip is clear and all details are visible</li>
          <li>Make sure the transaction ID, date, and amount are readable</li>
          <li>File size should not exceed 5MB</li>
          <li>Supported formats: JPG, PNG, PDF</li>
          <li>After upload, please keep your payment slip for reference</li>
          <li>Upload may take a few seconds depending on file size</li>
        </ol>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      <p>&copy; 2023 Your Company Name. All rights reserved.</p>
    </div>

    <!-- JavaScript -->
    <script>
      // Firebase Configuration - ඔබගේ config එක මෙහි ආදේශ කරන්න
      /**

 const firebaseConfig = {
        apiKey: "AIzaSyDMvwGMHMLeJVamAGgsvoDC9Z2uQ5fS5qY",
        authDomain: "akuratama-ict.firebaseapp.com",
        projectId: "akuratama-ict",
        storageBucket: "akuratama-ict.firebasestorage.app",
        messagingSenderId: "849122634140",
        appId: "1:849122634140:web:395470de690512a1f98059",
        measurementId: "G-XWC2DKR3ZZ",
      };
      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const storage = firebase.storage();


     */

      // DOM Elements
      const fileInput = document.getElementById("fileInput");
      const uploadArea = document.getElementById("uploadArea");
      const browseBtn = document.getElementById("browseBtn");
      const previewSection = document.getElementById("previewSection");
      const imagePreview = document.getElementById("imagePreview");
      const fileInfo = document.getElementById("fileInfo");
      const uploadBtn = document.getElementById("uploadBtn");
      const progressContainer = document.getElementById("progressContainer");
      const progressFill = document.getElementById("progressFill");
      const progressText = document.getElementById("progressText");
      const successMessage = document.getElementById("successMessage");
      const errorMessage = document.getElementById("errorMessage");

      let selectedFile = null;

      // Event Listeners
      browseBtn.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("click", () => fileInput.click());

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      });

      uploadArea.addEventListener("dragleave", () => {
        uploadArea.classList.remove("dragover");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("dragover");

        if (e.dataTransfer.files.length) {
          handleFileSelect(e.dataTransfer.files[0]);
        }
      });

      fileInput.addEventListener("change", (e) => {
        if (e.target.files.length) {
          handleFileSelect(e.target.files[0]);
        }
      });

      uploadBtn.addEventListener("click", uploadToFirebase);

      // Handle File Selection
      function handleFileSelect(file) {
        selectedFile = file;

        // Check file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
          alert("File size exceeds 5MB limit. Please choose a smaller file.");
          return;
        }

        // Check file type
        const validTypes = [
          "image/jpeg",
          "image/png",
          "image/jpg",
          "application/pdf",
        ];
        if (!validTypes.includes(file.type)) {
          alert("Please select a valid file type (JPG, PNG, or PDF).");
          return;
        }

        // Show file info
        fileInfo.innerHTML = `
                <p>File Name: <span>${file.name}</span></p>
                <p>File Size: <span>${formatFileSize(file.size)}</span></p>
                <p>File Type: <span>${file.type}</span></p>
                <p>Last Modified: <span>${new Date(
                  file.lastModified,
                ).toLocaleDateString()}</span></p>
            `;

        // Show preview for images
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = (e) => {
            imagePreview.src = e.target.result;
            imagePreview.style.display = "block";
          };
          reader.readAsDataURL(file);
        } else {
          // For PDF, show a placeholder
          imagePreview.src =
            "https://cdn-icons-png.flaticon.com/512/337/337946.png";
          imagePreview.style.display = "block";
        }

        // Show preview section and enable upload button
        previewSection.style.display = "block";
        uploadBtn.disabled = false;
        uploadArea.style.padding = "30px 20px";

        // Hide any previous messages
        successMessage.style.display = "none";
        errorMessage.style.display = "none";
      }

      const uploadProgress = (percentage) => {
        progressFill.style.width = percentage + "%";
        progressText.textContent = percentage + "% uploaded";
      };

      // Upload to Firebase
      async function uploadToFirebase() {
        if (!selectedFile) return;

        // Disable upload button and show progress
        uploadBtn.disabled = true;
        uploadBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Uploading...';
        progressContainer.style.display = "block";

        // Create a unique filename
        const timestamp = Date.now();
        const fileName = `payment_slips/payment_${timestamp}_${selectedFile.name}`;

        const courseId = new URLSearchParams(window.location.search).get(
          "courseId",
        );
        const student = await localStorage.getItem("STUDENT");

        await uploadBill(
          selectedFile,
          {
            courseId,
            studentId: student?.id,
          },
          resetForm,
          uploadProgress,
        )
          .then(() => {
            successMessage.style.display = "block";
            resetForm();
          })
          .catch((error) => {
            console.error("Upload error:", error);
            errorMessage.style.display = "block";
            uploadBtn.disabled = false;
            uploadBtn.innerHTML =
              '<i class="fas fa-upload"></i> Upload to Firebase';
            progressContainer.style.display = "none";
          });
      }

      // Helper Functions
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function resetForm() {
        fileInput.value = "";
        selectedFile = null;
        previewSection.style.display = "none";
        uploadBtn.disabled = true;
        uploadBtn.innerHTML =
          '<i class="fas fa-upload"></i> Upload to Firebase';
        progressContainer.style.display = "none";
        progressFill.style.width = "0%";
        progressText.textContent = "0% uploaded";
        uploadArea.style.padding = "60px 20px";
      }

      // Optional: Add animation to upload area
      uploadArea.addEventListener("mouseenter", () => {
        uploadArea.style.transform = "scale(1.02)";
      });

      uploadArea.addEventListener("mouseleave", () => {
        uploadArea.style.transform = "scale(1)";
      });
    </script>
  </body>
</html>
